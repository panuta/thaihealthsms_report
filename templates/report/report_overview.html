{% extends 'base_authenticated.html' %}
{% load page_tags %}

{% block head_title %}{{block.super}}รายงาน {{report.name}} งวดวันที่ {{submission.schedule_date|format_abbr_date}}{% endblock %}

{% block html_head %}
{{block.super}}
<script type="text/javascript" src="{{STATIC_URL}}libs/ckeditor/ckeditor.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}libs//ckeditor/adapters/jquery.js"></script>

<script>
var initializedTextarea = false;

$(document).ready(function() {
  $('.edit_report_button').on('click', function(e) {
    if(initializedTextarea == false) {
      var config = {
        toolbar:[['Bold', 'Italic', 'Underline', '-', 'NumberedList', 'BulletedList'],],
        language:'th'
      };
      $('.report_text_editor textarea').ckeditor(config);

      CKEDITOR.on( 'instanceReady', function( ev ) {
        ev.editor.dataProcessor.writer.setRules( 'p', {
          indent : false,
          breakBeforeOpen : true,
          breakAfterOpen : false,
          breakBeforeClose : false,
          breakAfterClose : true
        });
      });

      $('.report_text_editor button[type="button"]').on('click', function(e) {
        $('.report_text_editor').hide();
        $('.report_text').show();
        $('.report_actions').show();
      });
    }

    $('.report_text_editor').show();
    $('.report_text').hide();
    $('.report_actions').hide();

    return false;
  });

  $('.attach_report_button').on('click', function(e) {
    $('#report_attachment_form input[type="file"]').click();
    return false;
  });

  $('#report_attachment_form input[type="file"]').on('change', function(e) {
      $('#report_attachment_form').submit();
  });

});
</script>

{% endblock %}

{% block body_title %}{% include 'domain/snippets/project_header.html' %}{% endblock %}
{% block body_tabs %}{% include 'domain/snippets/project_tabs.html' with active_menu='report' %}{% endblock %}

{% block body_content %}
<div class="report_page">
  <ul class="breadcrumb">
    <li><a href="#">รายงานทั้งหมด</a> <span class="divider">/</span></li>
    <li class="active">รายงาน {{report.name}}</li>
  </ul>

  <h2>{{report.name}}<div class="subtitle">งวดวันที่ {{submission.schedule_date|format_abbr_date}}</div></h2>

  {% if report.submitted_on %}
  <div class="report_submitted">รายงานถูกส่งแล้วเมื่อวันที่ 14 ก.พ. 2555 เวลา 12:00 น.</div>
  {% endif %}

  <div class="report_actions">
    {% if not report.submitted_on %}{% if report.report_text or report.attachments %}<a href="#" class="primary submit btn">ส่งรายงาน</a>{% endif %}{% endif %}
    <a href="#" class="btn edit_report_button">{% if not submission.report_text %}เขียนเนื้อหารายงาน{% else %}แก้ไขเนื้อหารายงาน{% endif %}</a>
    <a href="#" class="btn attach_report_button">แนบไฟล์รายงาน</a>
  </div>

  {% if submission.report_text %}
  <div class="report_text">
    {{submission.report_text|safe}}
  </div>
  {% endif %}

  <div class="report_text_editor" style="display:none;">
    <form method="post" action="{% url submit_project_report_text project.id report.id submission.schedule_date|dateid %}">
      {% csrf_token %}
      <textarea name="report_text">{{submission.report_text|safe}}</textarea>
      <div class="button_panel"><button type="submit" class="primary btn">จัดเก็บ</button><button type="button" class="btn">ยกเลิก</button></div>
    </form>
  </div>

  {% if submission.attachments %}
  <div class="report_attachment">
    <h3>ไฟล์แนบ</h3>
    <ul>
      {% for attachment in submission.attachments %}
      <li>
        <div class="filename"><a href="{% url download_report_attachment attachment.uid %}">{{attachment.file_name}}.{{attachment.file_ext}}</a></div>
        <div class="metadata">อัพโหลดเมื่อวันที่ {{attachment.uploaded|format_abbr_datetime}} โดย {{attachment.uploaded_by.get_profile.get_fullname}}</div>
      </li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <form method="post" id="report_attachment_form" action="{% url submit_project_report_attachment project.id report.id submission.schedule_date|dateid %}" enctype="multipart/form-data">
    {% csrf_token %}
    {{attachment_form.errors}}
    <input type="file" name="report_attachment" id="id_report_attachment" style="opacity:0;text-indent:-9999px;"/>
  </form>

</div>
{% endblock %}